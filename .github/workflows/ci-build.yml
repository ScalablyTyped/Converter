name: CI Build
on:
  pull_request:
    branches: [ 'master' ]
  push:
    branches: [ 'master' ]

jobs:
  scalafmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/setup-action@v1
        with:
          apps: scalafmt

      - uses: coursier/cache-action@v6.4

      - name: Scalafmt
        run: scalafmt -c .scalafmt.conf --check

  build:
    name: CI Build on ${{ matrix.os }} (Scala ${{ matrix.scala }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            scala: "2.12"
          - os: ubuntu-latest
            scala: "3"
          - os: macos-latest-large
            scala: "2.12"
          - os: macos-latest-large
            scala: "3"
          - os: windows-latest
            scala: "2.12"
          - os: windows-latest
            scala: "3"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: coursier/cache-action@v6.4

      - uses: coursier/setup-action@v1
        with:
          jvm: adoptium:1.21.0.1
          apps: sbt

      - name: Get tests folder sha
        id: get-tests-folder-sha
        run: |
          echo "sha=$(git ls-tree HEAD tests --object-only)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v4
        with:
          path: test-cache
          key: ${{ runner.os }}-${{ steps.get-tests-folder-sha.outputs.sha }}-test-cache-v1

      - name: Build and test
        run: sbt "++${{ matrix.scala == '3' && '3.3.4' || '2.12.20' }}" test
        env:
          CI: true
          CI_TEST_CACHE: ../test-cache

# commented out while I figure out how to speed it up or when to run it
#  sbt-scripted-tests:
#    name: Run sbt scripted tests
#    runs-on: ubuntu-latest
#    timeout-minutes: 25
#    steps:
#      - uses: actions/checkout@v4
#        with:
#          fetch-depth: 0
#
#      - uses: coursier/cache-action@v6.4
#
#      # cache artifacts within same date. should help a bit with the compile time
#      - name: Get timestamp
#        id: get-date
#        run: |
#          echo "time=$(date +%yy-%m-%d)" >> $GITHUB_OUTPUT
#
#      - uses: actions/cache@v4
#        with:
#          path: ~/.ivy2/local/org.scalablytyped
#          key: scripted-v1-${{ steps.get-date.outputs.time }}
#
#      - uses: coursier/setup-action@v1
#        with:
#          jvm: adoptium:1.21.0.1
#          apps: sbt
#
#      - name: Run scripted
#        run: sbt scripted
